# AI会议助手数据模型设计文档

## 1. 文档概述

### 1.1 文档目的
本文档详细描述AI会议助手的数据模型设计，包括PostgreSQL表结构、MongoDB集合结构、数据关系、索引设计等，为开发团队提供明确的数据设计依据，确保数据存储合理、高效、可扩展。

### 1.2 术语定义
| 术语 | 解释 |
|------|------|
| 关系型数据库 | 采用关系模型组织数据的数据库，如PostgreSQL |
| 文档型数据库 | 采用文档模型组织数据的数据库，如MongoDB |
| 表 | 关系型数据库中存储数据的结构 |
| 集合 | 文档型数据库中存储数据的结构 |
| 字段 | 表或集合中的数据项 |
| 主键 | 唯一标识表中记录的字段 |
| 外键 | 关联其他表的字段 |
| 索引 | 提高查询性能的数据结构 |
| 关系 | 表或集合之间的关联关系 |

## 2. 数据存储策略

### 2.1 存储方案
- **关系型数据**：存储在PostgreSQL中，如会议基本信息、用户信息、发言者信息等
- **半结构化数据**：存储在MongoDB中，如发言记录、AI分析结果等
- **文件数据**：存储在对象存储服务中，如录音文件、导出的会议记录等

### 2.2 数据分类
| 数据类型 | 存储位置 | 示例数据 |
|----------|----------|----------|
| 结构化数据 | PostgreSQL | 会议ID、会议名称、发言者姓名等 |
| 半结构化数据 | MongoDB | 发言内容、AI分析结果、转写置信度等 |
| 文件数据 | 对象存储 | 录音MP3文件、导出的PDF文档等 |

## 3. PostgreSQL表结构设计

### 3.1 会话表（sessions）

**功能描述**：存储会议会话的基本信息

**表结构**：
| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | UUID | PRIMARY KEY | 会话唯一标识符 |
| name | VARCHAR(255) | NOT NULL | 会话名称 |
| status | VARCHAR(20) | NOT NULL DEFAULT 'active' | 会话状态（active: 活跃, ended: 已结束） |
| created_at | TIMESTAMP | NOT NULL DEFAULT CURRENT_TIMESTAMP | 会话创建时间 |
| ended_at | TIMESTAMP | NULL | 会话结束时间 |
| duration | INTEGER | NULL | 会话时长（秒） |
| recording_quality | VARCHAR(20) | NOT NULL DEFAULT 'medium' | 录音质量（low: 低, medium: 中, high: 高） |
| transcription_language | VARCHAR(50) | NOT NULL DEFAULT 'zh-CN' | 转写语言 |

**索引设计**：
| 索引类型 | 字段 | 用途 |
|----------|------|------|
| 主键索引 | id | 唯一标识会话 |
| 普通索引 | created_at | 按创建时间查询会话列表 |
| 普通索引 | status | 按状态筛选会话 |

### 3.2 发言者表（speakers）

**功能描述**：存储发言者信息

**表结构**：
| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | UUID | PRIMARY KEY | 发言者唯一标识符 |
| session_id | UUID | NOT NULL REFERENCES sessions(id) ON DELETE CASCADE | 所属会话ID |
| name | VARCHAR(100) | NOT NULL | 发言者名称 |
| color | VARCHAR(20) | NULL | 发言者显示颜色 |
| is_default | BOOLEAN | NOT NULL DEFAULT FALSE | 是否为默认发言者 |
| created_at | TIMESTAMP | NOT NULL DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**索引设计**：
| 索引类型 | 字段 | 用途 |
|----------|------|------|
| 主键索引 | id | 唯一标识发言者 |
| 普通索引 | session_id | 按会话查询发言者列表 |
| 普通索引 | name | 按名称搜索发言者 |

### 3.3 用户表（users）

**功能描述**：存储用户信息（预留多用户支持）

**表结构**：
| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | UUID | PRIMARY KEY | 用户唯一标识符 |
| username | VARCHAR(100) | NOT NULL UNIQUE | 用户名 |
| email | VARCHAR(255) | NOT NULL UNIQUE | 邮箱 |
| password_hash | VARCHAR(255) | NOT NULL | 密码哈希 |
| name | VARCHAR(100) | NULL | 用户真实姓名 |
| avatar | VARCHAR(255) | NULL | 用户头像URL |
| created_at | TIMESTAMP | NOT NULL DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL DEFAULT CURRENT_TIMESTAMP | 更新时间 |
| last_login_at | TIMESTAMP | NULL | 最后登录时间 |

**索引设计**：
| 索引类型 | 字段 | 用途 |
|----------|------|------|
| 主键索引 | id | 唯一标识用户 |
| 唯一索引 | username | 按用户名查询用户 |
| 唯一索引 | email | 按邮箱查询用户 |

## 4. MongoDB集合结构设计

### 4.1 发言记录表（speeches）

**功能描述**：存储会议发言记录

**集合结构**：
```json
{
  "_id": ObjectId,                 // 发言记录唯一标识符
  "session_id": UUID,              // 所属会话ID
  "speaker_id": UUID,              // 发言者ID
  "speaker_name": String,          // 发言者名称（冗余字段，提高查询性能）
  "content": String,               // 发言内容
  "start_time": Date,              // 发言开始时间
  "end_time": Date,                // 发言结束时间
  "duration": Number,              // 发言时长（秒）
  "confidence": Number,            // 转写置信度（0-1）
  "is_edited": Boolean,            // 是否被编辑过
  "edited_at": Date,               // 最后编辑时间
  "created_at": Date,              // 创建时间
  "audio_url": String,             // 发言录音URL（可选）
  "metadata": {                    // 元数据
    "transcription_service": String,  // 使用的语音识别服务
    "language": String,              // 发言语言
    "channel": Number                // 音频通道数
  }
}
```

**索引设计**：
| 索引类型 | 字段 | 用途 |
|----------|------|------|
| 主键索引 | _id | 唯一标识发言记录 |
| 普通索引 | session_id | 按会话查询发言记录 |
| 普通索引 | speaker_id | 按发言者查询发言记录 |
| 普通索引 | start_time | 按时间顺序查询发言记录 |
| 全文索引 | content | 按关键词搜索发言内容 |

### 4.2 AI分析表（ai_analyses）

**功能描述**：存储AI分析结果

**集合结构**：
```json
{
  "_id": ObjectId,                 // 分析记录唯一标识符
  "speech_id": ObjectId,           // 关联的发言记录ID
  "session_id": UUID,              // 所属会话ID（冗余字段，提高查询性能）
  "model_name": String,            // 使用的AI模型名称
  "core_analysis": String,         // 核心要点分析
  "brief_answer": String,          // 简要回答
  "deep_answer": String,           // 深度回答
  "prompt": String,                // 使用的AI提示词
  "tokens_used": Number,           // 消耗的token数
  "generated_at": Date,            // 分析生成时间
  "confidence": Number,            // 分析置信度（0-1）
  "metadata": {                    // 元数据
    "api_version": String,          // AI API版本
    "response_time": Number         // API响应时间（毫秒）
  }
}
```

**索引设计**：
| 索引类型 | 字段 | 用途 |
|----------|------|------|
| 主键索引 | _id | 唯一标识分析记录 |
| 普通索引 | speech_id | 按发言记录查询AI分析结果 |
| 普通索引 | session_id | 按会话查询AI分析结果 |
| 普通索引 | model_name | 按模型名称查询分析结果 |
| 普通索引 | generated_at | 按生成时间查询分析结果 |

## 5. 数据关系设计

### 5.1 PostgreSQL表关系

```
┌─────────────┐      ┌─────────────┐      ┌─────────────┐
│   users     │      │  sessions   │      │  speakers   │
└─────────────┘      └─────────────┘      └─────────────┘
       │                    │                    │
       │ 1                1 │ N                1 │ N
       │                    │                    │
       ▼                    ▼                    ▼
┌─────────────┐      ┌─────────────┐      ┌─────────────┐
│   users     │◀─────│  sessions   │◀─────│  speakers   │
└─────────────┘      └─────────────┘      └─────────────┘
```

### 5.2 MongoDB集合关系

```
┌─────────────┐      ┌─────────────┐
│  sessions   │      │  speakers   │
└─────────────┘      └─────────────┘
       │                    │
       │ 1                N │
       │                    │
       ▼                    ▼
┌─────────────┐      ┌─────────────┐
│  speeches   │─────▶│ ai_analyses │
└─────────────┘      └─────────────┘
       │ 1                    │ N
       │                      │
       ▼                      ▼
┌─────────────┐      ┌─────────────┐
│  speeches   │◀─────│ ai_analyses │
└─────────────┘      └─────────────┘
```

### 5.3 跨数据库关系

| 关系类型 | 源数据 | 目标数据 | 关联字段 |
|----------|--------|----------|----------|
| 1:N | sessions(id) | speeches(session_id) | session_id |
| 1:N | speakers(id) | speeches(speaker_id) | speaker_id |
| 1:N | speeches(_id) | ai_analyses(speech_id) | speech_id |
| 1:N | sessions(id) | ai_analyses(session_id) | session_id |

## 6. 数据迁移策略

### 6.1 初始数据迁移
- 使用Sequelize和Mongoose的自动迁移功能创建表和集合
- 初始化基础数据（如默认发言者、系统设置等）

### 6.2 增量数据迁移
- 使用数据库迁移工具（如Flyway、Liquibase）管理PostgreSQL的schema变更
- MongoDB使用集合版本控制，通过应用代码处理schema变更

### 6.3 数据备份与恢复
- PostgreSQL：使用pg_dump定期备份，支持全量备份和增量备份
- MongoDB：使用mongodump定期备份，支持全量备份和增量备份
- 备份数据存储在异地，确保数据安全

## 7. 数据访问策略

### 7.1 读写分离
- 针对PostgreSQL，考虑在高并发场景下实现读写分离
- 主库处理写操作，从库处理读操作
- 使用数据库中间件（如Pgpool-II）实现自动读写分离

### 7.2 缓存策略
- 热点数据（如会议列表、常用发言者等）缓存到内存中
- 使用应用级缓存（如Node.js的Map对象）或分布式缓存（如Redis，可选）
- 缓存失效策略：定期失效+主动失效

### 7.3 数据分页
- 列表查询使用分页，减少单次查询的数据量
- 分页参数：page（页码）、page_size（每页条数）
- 默认page_size：20条

## 8. 数据安全设计

### 8.1 数据加密
- 传输加密：使用SSL/TLS加密数据传输
- 存储加密：
  - PostgreSQL：使用透明数据加密（TDE）加密数据文件
  - MongoDB：使用WiredTiger存储引擎的加密功能
- 敏感字段加密：如用户密码使用bcrypt加密存储

### 8.2 访问控制
- 基于角色的访问控制（RBAC）
- 最小权限原则：只授予必要的访问权限
- 定期审计访问日志，发现异常访问

### 8.3 数据脱敏
- 敏感数据在日志和API响应中脱敏
- 如用户邮箱显示为：xxx@xxx.com

## 9. 性能优化设计

### 9.1 查询优化
- 合理设计索引，提高查询性能
- 避免全表扫描，使用索引覆盖查询
- 优化SQL查询，避免复杂的JOIN操作

### 9.2 写入优化
- 批量写入：减少数据库连接开销
- 异步写入：非关键数据使用异步写入
- 合理设置MongoDB的写入关注级别

### 9.3 存储优化
- 定期清理过期数据
- 压缩存储：PostgreSQL使用TOAST压缩大字段，MongoDB使用WiredTiger压缩
- 分区表：PostgreSQL对大表使用分区，提高查询性能

## 10. 数据模型验证

### 10.1 验证规则
- **PostgreSQL**：使用表约束和CHECK约束验证数据
- **MongoDB**：使用Mongoose Schema验证数据
- **应用层**：在API层再次验证数据，确保数据完整性

### 10.2 验证内容
- 数据类型验证
- 字段长度验证
- 格式验证（如邮箱、日期等）
- 业务规则验证

## 11. 附录

### 11.1 参考文档
- AI会议助手功能需求说明书
- 系统架构设计文档
- PostgreSQL官方文档
- MongoDB官方文档

### 11.2 版本历史
| 版本 | 日期 | 作者 | 变更内容 |
|------|------|------|----------|
| V1.0 | 2026-01-09 | AI助手 | 初始版本 |
